# toolrun Single Tool Execution
# Execution pipeline with backend dispatch

direction: right

vars: {
  d2-config: {
    layout-engine: elk
    theme-id: 0
  }
  execution-fill: "#38a169"
  process-fill: "#3182ce"
  backend-fill: "#805ad5"
  output-fill: "#d69e2e"
}

classes: {
  container: {
    style: {
      border-radius: 12
      shadow: true
      font-size: 14
      bold: true
    }
  }
  execution-node: {
    style: {
      fill: ${execution-fill}
      stroke: "#276749"
      stroke-width: 2
      font-color: "#fff"
    }
  }
  process-node: {
    style: {
      fill: ${process-fill}
      stroke: "#2c5282"
      stroke-width: 2
      font-color: "#fff"
    }
  }
  backend-node: {
    style: {
      fill: ${backend-fill}
      stroke: "#6b46c1"
      stroke-width: 2
      font-color: "#fff"
    }
  }
  output-node: {
    style: {
      fill: ${output-fill}
      stroke: "#b7791f"
      stroke-width: 2
      font-color: "#fff"
    }
  }
  data-flow: {
    style: {
      stroke: "#4a5568"
      stroke-width: 2
    }
  }
  dispatch-flow: {
    style: {
      stroke: ${backend-fill}
      stroke-width: 2
      stroke-dash: 3
    }
  }
}

# Title
title: "toolrun - Single Tool Execution" {
  shape: text
  near: top-center
  style: {
    font-size: 24
    bold: true
    font-color: "#1a365d"
  }
}

# Pipeline
run: "â–¶ï¸ Run\nEntry Point" {
  shape: step
  class: execution-node
}

resolve: "ğŸ” Resolve\nTool + Backends" {
  shape: step
  class: process-node
}

select: "ğŸ¯ Select Backend\nPriority Order" {
  shape: diamond
  class: process-node
}

validate_in: "âœ“ Validate Input\nJSON Schema" {
  shape: step
  class: process-node
}

# Dispatch Container
dispatch: "ğŸš€ Dispatch" {
  class: container
  style: {
    fill: "#faf5ff"
    stroke: ${backend-fill}
  }

  mcp: "â˜ï¸ MCP\nRemote Server" {
    shape: cloud
    class: backend-node
  }
  provider: "ğŸ”Œ Provider\nIntegration" {
    shape: hexagon
    class: backend-node
  }
  local: "ğŸ’» Local\nIn-Process" {
    shape: step
    class: backend-node
  }
}

normalize: "ğŸ“‹ Normalize Result\nStructured Output" {
  shape: step
  class: output-node
}

validate_out: "âœ“ Validate Output\nOptional" {
  shape: step
  class: output-node
}

# Flow
run -> resolve: "tool_id" {
  class: data-flow
}
resolve -> select: "backends" {
  class: data-flow
}
select -> validate_in: "selected" {
  class: data-flow
}
validate_in -> dispatch: "args" {
  class: data-flow
}

dispatch -> dispatch.mcp {
  class: dispatch-flow
}
dispatch -> dispatch.provider {
  class: dispatch-flow
}
dispatch -> dispatch.local {
  class: dispatch-flow
}

dispatch -> normalize: "raw result" {
  class: data-flow
}
normalize -> validate_out: "result" {
  class: data-flow
}
